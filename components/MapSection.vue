<template>
  <div class="map">
    <!-- Десктопная версия с сайдбаром -->
    <div v-if="!isMobile" class="map__sidebar">
      <div class="map__sidebar-content">
        <h3 class="map__sidebar-title" @click="isSidebarOpen = !isSidebarOpen">
          Локации
          <span class="map__m" :class="{ 'map__m--open': !isSidebarOpen }">
            <svg width="11" height="8" viewBox="0 0 11 8" fill="none">
              <path
                d="M4.71429 0.497991C5.11466 -0.0105564 5.88534 -0.0105563 6.28572 0.497991L10.7209 6.13141C11.2373 6.78739 10.7701 7.75 9.93517 7.75L1.06483 7.75C0.229947 7.75 -0.237333 6.78739 0.279119 6.13141L4.71429 0.497991Z"
                fill="#4C5E36"
              />
            </svg>
          </span>
        </h3>

        <ul v-show="isSidebarOpen" class="map__categories">
          <li
            v-for="cat in categories"
            :key="cat.key"
            class="map__category"
            :class="{ inactive: !cat.active }"
            @click="toggleCategory(cat)"
            @mouseenter="handleCategoryMouseEnter(cat.key)"
            @mouseleave="handleCategoryMouseLeave"
          >
            <div class="map__category-name">
              <div
                v-html="categoryIcon(cat.key, !isMd && hoveredCategory === cat.key)"
                class="map__icon"
                :class="{
                  'map__icon--inactive': !cat.active,
                  'map__icon--hovered': !isMd && hoveredCategory === cat.key,
                }"
              />
              <AnimatedLink
                :text="cat.name"
                customClass="map__category-name-link"
                :hoverColor="isMd ? '' : '#ff6b35'"
                :forceHover="!isMd && hoveredCategory === cat.key"
                :disableAnimation="isMd || !cat.active"
              />
            </div>

            <span
              class="map__category-count"
              :class="{ 'map__category-count--hovered': hoveredCategory === cat.key }"
            >
              {{ totalCountByCategory[cat.key] || 0 }}
            </span>
          </li>
        </ul>
      </div>
    </div>

    <!-- Мобильная версия - превью с оверлеем -->
    <div v-if="isMapReady && isMobile" class="map__mobile-preview" @click="openMapDialog">
      <YandexMap
        key="mobile-map"
        :center="mapCenter"
        :zoom="mapZoom"
        :locations="locations"
        :activeCategories="activeCategoryKeys"
        :disableInteraction="true"
        :showZoomControls="false"
      />
      <div class="map__mobile-overlay">
        <div class="map__mobile-icon">
          <svg
            width="36"
            height="48"
            viewBox="0 0 36 48"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle opacity="0.234747" cx="15" cy="15" r="13.5" stroke="#FF8A00" stroke-width="3" />
            <circle cx="15" cy="15" r="7.5" stroke="#FF8A00" stroke-width="3" />
            <g filter="url(#filter0_d_367_925)">
              <mask
                id="path-3-outside-1_367_925"
                maskUnits="userSpaceOnUse"
                x="5.5"
                y="11.5"
                width="25"
                height="31"
                fill="black"
              >
                <rect fill="white" x="5.5" y="11.5" width="25" height="31" />
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M13.5 30L11.9234 27.968C11.0153 26.5805 9.08105 26.0743 7.60151 26.8349L7.94626 26.6577C7.57908 26.8465 7.40301 27.3171 7.55419 27.7082L9.3951 32.4711C9.68694 33.2262 10.4323 34.294 11.0499 34.8305C11.0499 34.8305 15 37.8958 15 39.045V40.5H21L22.5 37.5L24 40.5H25.5V39.045C25.5 37.8958 27.5166 34.276 27.5166 34.276C27.9332 33.5724 28.5 32.3329 28.5 31.5099V25.4577C28.4729 24.1177 27.1143 23.0318 25.7089 23.0318C25.0058 23.0318 24.4363 23.5748 24.4363 24.2451V24.7299C24.4363 23.3899 23.2973 22.304 21.8919 22.304C21.1888 22.304 20.6193 22.8469 20.6193 23.5173V24.002C20.6193 22.6621 19.4803 21.5761 18.0748 21.5761C17.3717 21.5761 16.5 22.1191 16.5 22.7894V23.2742C16.5 23.0588 16.5445 22.8876 16.5 22.752V15.0018C16.4475 14.1566 15.5818 13.5 14.7533 13.5C13.9191 13.5 13.5 14.1714 13.5 14.9997V22.5V30ZM18 28.5H19.5V34.5H18V28.5ZM21 28.5H22.5V34.5H21V28.5ZM24 28.5H25.5V34.5H24V28.5Z"
                />
              </mask>
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M13.5 30L11.9234 27.968C11.0153 26.5805 9.08105 26.0743 7.60151 26.8349L7.94626 26.6577C7.57908 26.8465 7.40301 27.3171 7.55419 27.7082L9.3951 32.4711C9.68694 33.2262 10.4323 34.294 11.0499 34.8305C11.0499 34.8305 15 37.8958 15 39.045V40.5H21L22.5 37.5L24 40.5H25.5V39.045C25.5 37.8958 27.5166 34.276 27.5166 34.276C27.9332 33.5724 28.5 32.3329 28.5 31.5099V25.4577C28.4729 24.1177 27.1143 23.0318 25.7089 23.0318C25.0058 23.0318 24.4363 23.5748 24.4363 24.2451V24.7299C24.4363 23.3899 23.2973 22.304 21.8919 22.304C21.1888 22.304 20.6193 22.8469 20.6193 23.5173V24.002C20.6193 22.6621 19.4803 21.5761 18.0748 21.5761C17.3717 21.5761 16.5 22.1191 16.5 22.7894V23.2742C16.5 23.0588 16.5445 22.8876 16.5 22.752V15.0018C16.4475 14.1566 15.5818 13.5 14.7533 13.5C13.9191 13.5 13.5 14.1714 13.5 14.9997V22.5V30ZM18 28.5H19.5V34.5H18V28.5ZM21 28.5H22.5V34.5H21V28.5ZM24 28.5H25.5V34.5H24V28.5Z"
                fill="#F8F3ED"
              />
              <path
                d="M13.5 30L12.3149 30.9195C12.7079 31.4261 13.3794 31.6268 13.986 31.4191C14.5925 31.2114 15 30.6411 15 30H13.5ZM11.9234 27.968L10.6683 28.7894C10.6903 28.823 10.7137 28.8558 10.7383 28.8875L11.9234 27.968ZM6.91569 25.5009C6.17892 25.8797 5.88871 26.784 6.26748 27.5208C6.64625 28.2575 7.55057 28.5478 8.28734 28.169L7.60151 26.8349L6.91569 25.5009ZM8.63208 27.9917C9.36885 27.613 9.65906 26.7087 9.28029 25.9719C8.90152 25.2351 7.9972 24.9449 7.26043 25.3237L7.94626 26.6577L8.63208 27.9917ZM7.55419 27.7082L6.15506 28.249V28.249L7.55419 27.7082ZM9.3951 32.4711L10.7942 31.9303L9.3951 32.4711ZM11.0499 34.8305L10.0663 35.963C10.0872 35.9811 10.1085 35.9986 10.1303 36.0155L11.0499 34.8305ZM15 40.5H13.5C13.5 41.3284 14.1716 42 15 42V40.5ZM21 40.5V42C21.5682 42 22.0876 41.679 22.3416 41.1708L21 40.5ZM22.5 37.5L23.8416 36.8292C23.5876 36.321 23.0682 36 22.5 36C21.9318 36 21.4124 36.321 21.1584 36.8292L22.5 37.5ZM24 40.5L22.6584 41.1708C22.9124 41.679 23.4318 42 24 42V40.5ZM25.5 40.5V42C26.3284 42 27 41.3284 27 40.5H25.5ZM27.5166 34.276L26.2259 33.5118C26.2192 33.5231 26.2126 33.5345 26.2062 33.546L27.5166 34.276ZM28.5 25.4577H30C30 25.4476 29.9999 25.4375 29.9997 25.4273L28.5 25.4577ZM22.9363 24.7299C22.9363 25.5583 23.6079 26.2299 24.4363 26.2299C25.2647 26.2299 25.9363 25.5583 25.9363 24.7299H24.4363H22.9363ZM19.1193 24.002C19.1193 24.8304 19.7908 25.502 20.6193 25.502C21.4477 25.502 22.1193 24.8304 22.1193 24.002H20.6193H19.1193ZM15 23.2742C15 24.1026 15.6716 24.7742 16.5 24.7742C17.3284 24.7742 18 24.1026 18 23.2742H16.5H15ZM16.5 22.752H15C15 22.9107 15.0252 23.0684 15.0746 23.2192L16.5 22.752ZM16.5 15.0018H18C18 14.9708 17.999 14.9398 17.9971 14.9088L16.5 15.0018ZM13.5 14.9997H12H13.5ZM19.5 28.5H21C21 28.1022 20.842 27.7206 20.5607 27.4393C20.2794 27.158 19.8978 27 19.5 27V28.5ZM19.5 34.5V36C20.3284 36 21 35.3284 21 34.5H19.5ZM18 34.5H16.5C16.5 35.3284 17.1716 36 18 36V34.5ZM22.5 28.5H24C24 28.1022 23.842 27.7206 23.5607 27.4393C23.2794 27.158 22.8978 27 22.5 27V28.5ZM22.5 34.5V36C23.3284 36 24 35.3284 24 34.5H22.5ZM21 34.5H19.5C19.5 35.3284 20.1716 36 21 36V34.5ZM25.5 28.5H27C27 28.1022 26.842 27.7206 26.5607 27.4393C26.2794 27.158 25.8978 27 25.5 27V28.5ZM25.5 34.5V36C26.3284 36 27 35.3284 27 34.5H25.5ZM24 34.5H22.5C22.5 35.3284 23.1716 36 24 36V34.5ZM13.5 30L14.6851 29.0805L13.1085 27.0485L11.9234 27.968L10.7383 28.8875L12.3149 30.9195L13.5 30ZM11.9234 27.968L13.1785 27.1466C11.8471 25.1123 9.07338 24.3916 6.91569 25.5009L7.60151 26.8349L8.28734 28.169C9.08873 27.757 10.1835 28.0487 10.6683 28.7894L11.9234 27.968ZM7.60151 26.8349L8.28734 28.169L8.63208 27.9917L7.94626 26.6577L7.26043 25.3237L6.91569 25.5009L7.60151 26.8349ZM7.94626 26.6577L7.26043 25.3237C6.1966 25.8706 5.73332 27.1578 6.15506 28.249L7.55419 27.7082L8.95332 27.1674C9.02169 27.3443 9.00678 27.5094 8.96103 27.6319C8.91541 27.7541 8.81471 27.8979 8.63208 27.9917L7.94626 26.6577ZM7.55419 27.7082L6.15506 28.249L7.99597 33.0119L9.3951 32.4711L10.7942 31.9303L8.95332 27.1674L7.55419 27.7082ZM9.3951 32.4711L7.99597 33.0119C8.37504 33.9926 9.262 35.2644 10.0663 35.963L11.0499 34.8305L12.0335 33.698C11.6026 33.3237 10.9988 32.4597 10.7942 31.9303L9.3951 32.4711ZM11.0499 34.8305C10.1303 36.0155 10.1302 36.0154 10.1301 36.0154C10.1301 36.0154 10.1301 36.0153 10.1301 36.0153C10.13 36.0153 10.1301 36.0153 10.1302 36.0154C10.1304 36.0156 10.1308 36.0159 10.1315 36.0164C10.1328 36.0174 10.135 36.0192 10.1382 36.0217C10.1445 36.0266 10.1543 36.0343 10.1676 36.0447C10.194 36.0654 10.2337 36.0968 10.2849 36.1376C10.3873 36.2192 10.5351 36.3381 10.7129 36.4847C11.0701 36.7793 11.5415 37.1795 12.0085 37.6099C12.4826 38.0467 12.919 38.4843 13.2256 38.8561C13.38 39.0432 13.4728 39.1795 13.52 39.2642C13.5857 39.3821 13.5 39.2847 13.5 39.045H15H16.5C16.5 38.5181 16.2909 38.0735 16.1405 37.8038C15.9717 37.5009 15.756 37.2091 15.54 36.9472C15.106 36.4211 14.5548 35.8768 14.0414 35.4037C13.5209 34.924 13.0047 34.4861 12.6213 34.17C12.4289 34.0113 12.268 33.8818 12.1544 33.7913C12.0976 33.746 12.0524 33.7104 12.021 33.6857C12.0053 33.6733 11.993 33.6637 11.9843 33.657C11.98 33.6536 11.9766 33.6509 11.9741 33.649C11.9729 33.648 11.9719 33.6472 11.9711 33.6466C11.9707 33.6464 11.9704 33.6461 11.9701 33.6459C11.97 33.6458 11.9698 33.6457 11.9698 33.6456C11.9696 33.6455 11.9695 33.6454 11.0499 34.8305ZM15 39.045H13.5V40.5H15H16.5V39.045H15ZM15 40.5V42H21V40.5V39H15V40.5ZM21 40.5L22.3416 41.1708L23.8416 38.1708L22.5 37.5L21.1584 36.8292L19.6584 39.8292L21 40.5ZM22.5 37.5L21.1584 38.1708L22.6584 41.1708L24 40.5L25.3416 39.8292L23.8416 36.8292L22.5 37.5ZM24 40.5V42H25.5V40.5V39H24V40.5ZM25.5 40.5H27V39.045H25.5H24V40.5H25.5ZM25.5 39.045H27C27 39.0627 27.0259 38.8551 27.2185 38.3446C27.3856 37.9018 27.6168 37.3856 27.8602 36.8795C28.1014 36.3778 28.3441 35.9074 28.5273 35.5611C28.6187 35.3885 28.6945 35.248 28.7472 35.1514C28.7735 35.1031 28.7939 35.0658 28.8076 35.0411C28.8144 35.0287 28.8195 35.0195 28.8228 35.0136C28.8244 35.0106 28.8256 35.0085 28.8263 35.0073C28.8266 35.0066 28.8269 35.0062 28.827 35.006C28.827 35.0059 28.8271 35.0058 28.8271 35.0058C28.8271 35.0058 28.827 35.0059 28.827 35.0059C28.827 35.006 28.827 35.006 27.5166 34.276C26.2062 33.546 26.2062 33.5461 26.2061 33.5462C26.2061 33.5463 26.206 33.5464 26.2059 33.5465C26.2058 33.5467 26.2056 33.547 26.2055 33.5474C26.2051 33.548 26.2046 33.5489 26.204 33.55C26.2027 33.5522 26.201 33.5553 26.1988 33.5593C26.1945 33.5671 26.1883 33.5784 26.1803 33.5928C26.1644 33.6216 26.1415 33.6633 26.1127 33.7162C26.055 33.8221 25.9734 33.9733 25.8756 34.158C25.6808 34.5264 25.4193 35.0327 25.1564 35.5796C24.8956 36.1221 24.6227 36.7264 24.4117 37.2854C24.2262 37.7769 24 38.4528 24 39.045H25.5ZM27.5166 34.276L28.8073 35.0403C29.0539 34.6238 29.3372 34.0637 29.5634 33.4791C29.7766 32.9282 30 32.2035 30 31.5099H28.5H27C27 31.6392 26.94 31.9458 26.7656 32.3963C26.6043 32.8132 26.3959 33.2246 26.2259 33.5118L27.5166 34.276ZM28.5 31.5099H30V25.4577H28.5H27V31.5099H28.5ZM28.5 25.4577L29.9997 25.4273C29.9757 24.2407 29.3656 23.2534 28.5903 22.5973C27.8164 21.9423 26.7864 21.5318 25.7089 21.5318V23.0318V24.5318C26.0368 24.5318 26.3888 24.6643 26.6523 24.8873C26.9144 25.1091 26.9972 25.3347 27.0003 25.4881L28.5 25.4577ZM25.7089 23.0318V21.5318C24.2456 21.5318 22.9363 22.6797 22.9363 24.2451H24.4363H25.9363C25.9363 24.3476 25.8902 24.4287 25.844 24.4727C25.799 24.5156 25.7479 24.5318 25.7089 24.5318V23.0318ZM24.4363 24.2451H22.9363V24.7299H24.4363H25.9363V24.2451H24.4363ZM24.4363 24.7299H25.9363C25.9363 22.4948 24.0575 20.804 21.8919 20.804V22.304V23.804C22.5371 23.804 22.9363 24.285 22.9363 24.7299H24.4363ZM21.8919 22.304V20.804C20.4286 20.804 19.1193 21.9519 19.1193 23.5173H20.6193H22.1193C22.1193 23.6197 22.0732 23.7008 22.027 23.7449C21.982 23.7878 21.9309 23.804 21.8919 23.804V22.304ZM20.6193 23.5173H19.1193V24.002H20.6193H22.1193V23.5173H20.6193ZM20.6193 24.002H22.1193C22.1193 21.767 20.2405 20.0761 18.0748 20.0761V21.5761V23.0761C18.7201 23.0761 19.1193 23.5571 19.1193 24.002H20.6193ZM18.0748 21.5761V20.0761C17.3761 20.0761 16.6813 20.3308 16.149 20.7129C15.6384 21.0794 15 21.779 15 22.7894H16.5H18C18 22.9573 17.9438 23.0737 17.9114 23.1244C17.8823 23.17 17.8683 23.1716 17.8985 23.1499C17.9263 23.13 17.9681 23.1075 18.0148 23.0917C18.0632 23.0752 18.0861 23.0761 18.0748 23.0761V21.5761ZM16.5 22.7894H15V23.2742H16.5H18V22.7894H16.5ZM16.5 23.2742H18C18 23.2709 18.0002 23.2595 18.0024 23.2281C18.0036 23.2112 18.0049 23.1952 18.007 23.169C18.0088 23.146 18.0114 23.1135 18.0136 23.0792C18.0202 22.9762 18.0443 22.6476 17.9254 22.2848L16.5 22.752L15.0746 23.2192C15.0338 23.0945 15.0238 22.9937 15.021 22.9416C15.0195 22.915 15.0197 22.8961 15.0199 22.8882C15.02 22.8804 15.0203 22.8788 15.0198 22.8872C15.0192 22.8962 15.0183 22.9083 15.0164 22.9312C15.0149 22.9509 15.0124 22.9819 15.0101 23.0135C15.0054 23.079 15 23.1698 15 23.2742H16.5ZM16.5 22.752H18V15.0018H16.5H15V22.752H16.5ZM16.5 15.0018L17.9971 14.9088C17.9398 13.9866 17.4468 13.2517 16.8731 12.7776C16.3027 12.3064 15.5475 12 14.7533 12V13.5V15C14.7642 15 14.7948 15.0027 14.8396 15.0195C14.8842 15.0363 14.9273 15.0615 14.9622 15.0903C15.0416 15.1559 15.0077 15.1718 15.0029 15.0948L16.5 15.0018ZM14.7533 13.5V12C13.8842 12 13.1266 12.3734 12.6255 13.0239C12.1609 13.6271 12 14.3543 12 14.9997L13.5 14.9997H15C15 14.9169 15.0107 14.8627 15.0185 14.8359C15.0263 14.8092 15.0274 14.8218 15.0022 14.8546C14.974 14.8912 14.9257 14.9357 14.8597 14.9677C14.794 14.9996 14.75 15 14.7533 15V13.5ZM13.5 14.9997H12V22.5H13.5H15V14.9997H13.5ZM13.5 22.5H12V30H13.5H15V22.5H13.5ZM18 28.5V30H19.5V28.5V27H18V28.5ZM19.5 28.5H18V34.5H19.5H21V28.5H19.5ZM19.5 34.5V33H18V34.5V36H19.5V34.5ZM18 34.5H19.5V28.5H18H16.5V34.5H18ZM21 28.5V30H22.5V28.5V27H21V28.5ZM22.5 28.5H21V34.5H22.5H24V28.5H22.5ZM22.5 34.5V33H21V34.5V36H22.5V34.5ZM21 34.5H22.5V28.5H21H19.5V34.5H21ZM24 28.5V30H25.5V28.5V27H24V28.5ZM25.5 28.5H24V34.5H25.5H27V28.5H25.5ZM25.5 34.5V33H24V34.5V36H25.5V34.5ZM24 34.5H25.5V28.5H24H22.5V34.5H24Z"
                fill="#2C322C"
                mask="url(#path-3-outside-1_367_925)"
              />
            </g>
            <defs>
              <filter
                id="filter0_d_367_925"
                x="1.5"
                y="9"
                width="33"
                height="39"
                filterUnits="userSpaceOnUse"
                color-interpolation-filters="sRGB"
              >
                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                <feColorMatrix
                  in="SourceAlpha"
                  type="matrix"
                  values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
                  result="hardAlpha"
                />
                <feOffset dy="1.5" />
                <feGaussianBlur stdDeviation="2.25" />
                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.2 0" />
                <feBlend
                  mode="normal"
                  in2="BackgroundImageFix"
                  result="effect1_dropShadow_367_925"
                />
                <feBlend
                  mode="normal"
                  in="SourceGraphic"
                  in2="effect1_dropShadow_367_925"
                  result="shape"
                />
              </filter>
            </defs>
          </svg>
        </div>
        <div class="map__mobile-text">Нажмите для просмотра карты</div>
      </div>
    </div>

    <!-- Десктопная карта -->
    <YandexMap
      v-if="isMapReady && !isMobile"
      key="desktop-map"
      :center="mapCenter"
      :zoom="mapZoom"
      :locations="locations"
      :activeCategories="activeCategoryKeys"
      :showZoomControls="true"
    />

    <!-- Мобильный диалог с картой -->
    <MapDialog
      v-model="isMapDialogOpen"
      :center="mapCenter"
      :zoom="mapZoom"
      :locations="locations"
      :categories="categories"
      :activeCategories="activeCategoryKeys"
      @toggle-category="toggleCategory"
    />
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onBeforeUnmount } from 'vue';
import YandexMap from '~/components/YandexMap.vue';
import AnimatedLink from './Common/AnimatedLink.vue';
import MapDialog from './Common/Dialogs/MapDialog.vue';

const cultureBlack = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_886_110)">
<path d="M17.5 12.5V2.5C17.5 1.83696 17.2366 1.20107 16.7678 0.732233C16.2989 0.263392 15.663 0 15 0L11.6667 0V0.833333C11.6667 1.27536 11.4911 1.69928 11.1785 2.01184C10.866 2.32441 10.442 2.5 10 2.5C9.55797 2.5 9.13405 2.32441 8.82149 2.01184C8.50893 1.69928 8.33333 1.27536 8.33333 0.833333V0H5C4.33696 0 3.70107 0.263392 3.23223 0.732233C2.76339 1.20107 2.5 1.83696 2.5 2.5V12.5H5.83333V14.1667H2.5V20H8.33333V19.1667C8.33333 18.7246 8.50893 18.3007 8.82149 17.9882C9.13405 17.6756 9.55797 17.5 10 17.5C10.442 17.5 10.866 17.6756 11.1785 17.9882C11.4911 18.3007 11.6667 18.7246 11.6667 19.1667V20H17.5V14.1667H14.1667V12.5H17.5ZM11.6667 14.1667H8.33333V12.5H11.6667V14.1667Z" fill="#4C5E36"/>
</g>
<defs>
<clipPath id="clip0_886_110">
<rect width="20" height="20" fill="#4C5E36"/>
</clipPath>
</defs>
</svg>
`;
const medicineBlack = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M17.5 4.16671H13.3333V0.833374H6.66667V4.16671H2.5C1.83696 4.16671 1.20107 4.4301 0.732233 4.89894C0.263392 5.36778 0 6.00367 0 6.66671L0 19.1667H20V6.66671C20 6.00367 19.7366 5.36778 19.2678 4.89894C18.7989 4.4301 18.163 4.16671 17.5 4.16671ZM8.33333 2.50004H11.6667V4.16671H8.33333V2.50004ZM13.3333 12.5H10.8333V15H9.16667V12.5H6.66667V10.8334H9.16667V8.33337H10.8333V10.8334H13.3333V12.5Z" fill="#4C5E36"/>
</svg>
`;
const educationBlack = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M20 6.66668V16.6667H18.3333V7.74168L11.7667 11.9767C11.2408 12.3183 10.6271 12.5001 10 12.5001C9.3729 12.5001 8.75924 12.3183 8.23333 11.9767L0 6.66668L8.23333 1.35585C8.75954 1.01506 9.37308 0.83374 10 0.83374C10.6269 0.83374 11.2405 1.01506 11.7667 1.35585L20 6.66668ZM10 14.1667C9.05365 14.166 8.12763 13.892 7.33333 13.3775L3.33333 10.8V17.0117L3.5775 17.2558C3.65583 17.3334 5.53917 19.1667 10 19.1667C14.4608 19.1667 16.3442 17.3334 16.4225 17.2558L16.6667 17.0117V10.8L12.6667 13.3775C11.8724 13.892 10.9464 14.166 10 14.1667Z" fill="#4C5E36"/>
</svg>
`;
const torgBlack = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_886_118)">
<path d="M17.4508 6.66667C17.035 2.9225 13.8542 0 10 0C6.14583 0 2.965 2.9225 2.54916 6.66667H-0.0175018L1.58083 17.8542C1.75583 19.0775 2.81916 20 4.05583 20H15.9442C17.18 20 18.2442 19.0775 18.4192 17.8542L20.0175 6.66667H17.4508ZM10 1.66667C12.9325 1.66667 15.36 3.845 15.7667 6.66667H4.23333C4.64 3.845 7.0675 1.66667 10 1.66667ZM6.66666 16.6667H5V10H6.66666V16.6667ZM10.8333 16.6667H9.16666V10H10.8333V16.6667ZM15 16.6667H13.3333V10H15V16.6667Z" fill="#4C5E36"/>
</g>
<defs>
<clipPath id="clip0_886_118">
<rect width="20" height="20" fill="#4C5E36"/>
</clipPath>
</defs>
</svg>
`;
const foodBlack = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_886_122)">
<path d="M15.5075 0.676624C15.2991 0.394337 15.0069 0.185028 14.6726 0.0785176C14.3382 -0.0279924 13.9788 -0.0262688 13.6455 0.0834429C13.3123 0.193155 13.0221 0.405257 12.8164 0.689529C12.6107 0.973801 12.5 1.31574 12.5 1.66662V20H14.1667V16.3883C18.1667 12.0116 20.3333 6.79662 15.5075 0.676624ZM10 -4.31517e-05V7.49996C10 8.163 9.73661 8.79888 9.26776 9.26772C8.79892 9.73657 8.16304 9.99996 7.5 9.99996H6.66666V20H5V9.99996H4.16666C3.50362 9.99996 2.86774 9.73657 2.3989 9.26772C1.93006 8.79888 1.66666 8.163 1.66666 7.49996V-4.31517e-05H3.33333V7.49996C3.33333 7.72097 3.42113 7.93293 3.57741 8.08921C3.73369 8.24549 3.94565 8.33329 4.16666 8.33329H5V-4.31517e-05H6.66666V8.33329H7.5C7.72101 8.33329 7.93297 8.24549 8.08925 8.08921C8.24553 7.93293 8.33333 7.72097 8.33333 7.49996V-4.31517e-05H10Z" fill="#4C5E36"/>
</g>
<defs>
<clipPath id="clip0_886_122">
<rect width="20" height="20" fill="#4C5E36"/>
</clipPath>
</defs>
</svg>
`;
const sportBlack = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_886_126)">
<path d="M19.2675 5.93501L17.2558 3.9225L18.9225 2.25584L17.7442 1.0775L16.0775 2.74417L14.0658 0.732505C13.8337 0.500314 13.5581 0.316127 13.2547 0.190464C12.9514 0.0648005 12.6263 0.00012207 12.2979 0.00012207C11.9696 0.00012207 11.6445 0.0648005 11.3411 0.190464C11.0378 0.316127 10.7622 0.500314 10.53 0.732505L8.17333 3.08917L11.9525 6.86917L6.86917 11.9525L3.08917 8.17334L0.7325 10.53C0.263823 10.9988 0.000534058 11.6346 0.000534058 12.2975C0.000534058 12.9604 0.263823 13.5962 0.7325 14.065L2.74417 16.0775L1.0775 17.7442L2.25583 18.9225L3.9225 17.2558L5.93417 19.2675C6.16632 19.4997 6.44194 19.6839 6.74528 19.8095C7.04862 19.9352 7.37374 19.9999 7.70208 19.9999C8.03042 19.9999 8.35555 19.9352 8.65889 19.8095C8.96223 19.6839 9.23785 19.4997 9.47 19.2675L11.8267 16.9108L8.0475 13.1308L13.1308 8.0475L16.91 11.8267L19.2667 9.47001C19.7353 9.00119 19.9986 8.36542 19.9986 7.7025C19.9986 7.03959 19.7362 6.40382 19.2675 5.93501Z" fill="#4C5E36"/>
</g>
<defs>
<clipPath id="clip0_886_126">
<rect width="20" height="20" fill="#4C5E36"/>
</clipPath>
</defs>
</svg>
`;
const servicesBlack = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_886_130)">
<path d="M15 2.5V3.33333H20V5H15V6.66667H20V8.33333H15V10H20V11.6667H15V13.3333H20V15H15V20H13.3333V2.5C13.3333 1.83696 13.5967 1.20107 14.0656 0.732233C14.5344 0.263392 15.1703 0 15.8333 0L20 0V1.66667H15.8333C15.6123 1.66667 15.4004 1.75446 15.2441 1.91074C15.0878 2.06702 15 2.27899 15 2.5ZM11.6667 16.6667C11.6697 17.3453 11.4646 18.0086 11.079 18.5671C10.6934 19.1256 10.1459 19.5525 9.51024 19.7902C8.87458 20.028 8.18131 20.0651 7.52387 19.8967C6.86642 19.7283 6.27641 19.3624 5.83333 18.8483C5.484 19.2502 5.04326 19.5622 4.5482 19.7582C4.05314 19.9542 3.51824 20.0284 2.98853 19.9745C2.45882 19.9207 1.94978 19.7404 1.50427 19.4488C1.05876 19.1572 0.68981 18.7629 0.428465 18.299C0.16712 17.8351 0.0210296 17.3153 0.00248921 16.7831C-0.0160511 16.251 0.0935008 15.7222 0.321925 15.2413C0.55035 14.7603 0.890963 14.3413 1.3151 14.0194C1.73924 13.6975 2.23448 13.4822 2.75917 13.3917L4.92667 8.33333L3.5525 5.12583C2.85625 3.50673 2.4981 1.76246 2.5 0L4.16667 0C4.16454 1.53689 4.47647 3.058 5.08333 4.47L5.83333 6.22L6.58333 4.47C7.19019 3.058 7.50213 1.53689 7.5 0H9.16667C9.16857 1.76246 8.81042 3.50673 8.11417 5.12583L6.74 8.33333L8.90667 13.3917C9.67814 13.5264 10.3776 13.9284 10.8822 14.5272C11.3869 15.1261 11.6646 15.8835 11.6667 16.6667ZM5 16.6667C5 16.337 4.90225 16.0148 4.71912 15.7407C4.53598 15.4666 4.27568 15.253 3.97114 15.1269C3.6666 15.0007 3.33148 14.9677 3.00818 15.032C2.68488 15.0963 2.38791 15.2551 2.15482 15.4882C1.92173 15.7212 1.763 16.0182 1.69869 16.3415C1.63438 16.6648 1.66739 16.9999 1.79353 17.3045C1.91968 17.609 2.1333 17.8693 2.40738 18.0525C2.68147 18.2356 3.0037 18.3333 3.33333 18.3333C3.77536 18.3333 4.19928 18.1577 4.51184 17.8452C4.82441 17.5326 5 17.1087 5 16.6667ZM5.83333 14.485C6.19387 14.0695 6.65206 13.7502 7.16667 13.5558L5.83333 10.4483L4.5 13.5558C5.01461 13.7502 5.4728 14.0695 5.83333 14.485ZM10 16.6667C10 16.337 9.90225 16.0148 9.71912 15.7407C9.53598 15.4666 9.27568 15.253 8.97114 15.1269C8.6666 15.0007 8.33148 14.9677 8.00818 15.032C7.68488 15.0963 7.38791 15.2551 7.15482 15.4882C6.92173 15.7212 6.763 16.0182 6.69869 16.3415C6.63438 16.6648 6.66739 16.9999 6.79353 17.3045C6.91968 17.609 7.1333 17.8693 7.40738 18.0525C7.68147 18.2356 8.0037 18.3333 8.33333 18.3333C8.77536 18.3333 9.19928 18.1577 9.51184 17.8452C9.8244 17.5326 10 17.1087 10 16.6667Z" fill="#4C5E36"/>
</g>
<defs>
<clipPath id="clip0_886_130">
<rect width="20" height="20" fill="#4C5E36"/>
</clipPath>
</defs>
</svg>
`;
const financeBlack = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M17.5 2.5H2.5C1.83696 2.5 1.20107 2.76339 0.732233 3.23223C0.263392 3.70107 0 4.33696 0 5V6.66667H20V5C20 4.33696 19.7366 3.70107 19.2678 3.23223C18.7989 2.76339 18.163 2.5 17.5 2.5Z" fill="#4C5E36"/>
<path d="M0 17.5H20V8.33333H0V17.5ZM5.83333 12.9167C5.83333 13.1639 5.76002 13.4056 5.62267 13.6111C5.48532 13.8167 5.2901 13.9769 5.06169 14.0715C4.83328 14.1661 4.58195 14.1909 4.33947 14.1426C4.09699 14.0944 3.87427 13.9754 3.69945 13.8005C3.52463 13.6257 3.40558 13.403 3.35735 13.1605C3.30912 12.9181 3.33387 12.6667 3.42848 12.4383C3.52309 12.2099 3.68331 12.0147 3.88887 11.8773C4.09443 11.74 4.33611 11.6667 4.58333 11.6667C4.91485 11.6667 5.2328 11.7984 5.46722 12.0328C5.70164 12.2672 5.83333 12.5851 5.83333 12.9167Z" fill="#4C5E36"/>
</svg>
`;

const cultureWhite = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_886_110)">
<path d="M17.5 12.5V2.5C17.5 1.83696 17.2366 1.20107 16.7678 0.732233C16.2989 0.263392 15.663 0 15 0L11.6667 0V0.833333C11.6667 1.27536 11.4911 1.69928 11.1785 2.01184C10.866 2.32441 10.442 2.5 10 2.5C9.55797 2.5 9.13405 2.32441 8.82149 2.01184C8.50893 1.69928 8.33333 1.27536 8.33333 0.833333V0H5C4.33696 0 3.70107 0.263392 3.23223 0.732233C2.76339 1.20107 2.5 1.83696 2.5 2.5V12.5H5.83333V14.1667H2.5V20H8.33333V19.1667C8.33333 18.7246 8.50893 18.3007 8.82149 17.9882C9.13405 17.6756 9.55797 17.5 10 17.5C10.442 17.5 10.866 17.6756 11.1785 17.9882C11.4911 18.3007 11.6667 18.7246 11.6667 19.1667V20H17.5V14.1667H14.1667V12.5H17.5ZM11.6667 14.1667H8.33333V12.5H11.6667V14.1667Z" fill="white"/>
</g>
<defs>
<clipPath id="clip0_886_110">
<rect width="20" height="20" fill="white"/>
</clipPath>
</defs>
</svg>
`;
const medicineWhite = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M17.5 4.16671H13.3333V0.833374H6.66667V4.16671H2.5C1.83696 4.16671 1.20107 4.4301 0.732233 4.89894C0.263392 5.36778 0 6.00367 0 6.66671L0 19.1667H20V6.66671C20 6.00367 19.7366 5.36778 19.2678 4.89894C18.7989 4.4301 18.163 4.16671 17.5 4.16671ZM8.33333 2.50004H11.6667V4.16671H8.33333V2.50004ZM13.3333 12.5H10.8333V15H9.16667V12.5H6.66667V10.8334H9.16667V8.33337H10.8333V10.8334H13.3333V12.5Z" fill="white"/>
</svg>
`;
const educationWhite = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M20 6.66668V16.6667H18.3333V7.74168L11.7667 11.9767C11.2408 12.3183 10.6271 12.5001 10 12.5001C9.3729 12.5001 8.75924 12.3183 8.23333 11.9767L0 6.66668L8.23333 1.35585C8.75954 1.01506 9.37308 0.83374 10 0.83374C10.6269 0.83374 11.2405 1.01506 11.7667 1.35585L20 6.66668ZM10 14.1667C9.05365 14.166 8.12763 13.892 7.33333 13.3775L3.33333 10.8V17.0117L3.5775 17.2558C3.65583 17.3334 5.53917 19.1667 10 19.1667C14.4608 19.1667 16.3442 17.3334 16.4225 17.2558L16.6667 17.0117V10.8L12.6667 13.3775C11.8724 13.892 10.9464 14.166 10 14.1667Z" fill="white"/>
</svg>
`;
const torgWhite = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_886_118)">
<path d="M17.4508 6.66667C17.035 2.9225 13.8542 0 10 0C6.14583 0 2.965 2.9225 2.54916 6.66667H-0.0175018L1.58083 17.8542C1.75583 19.0775 2.81916 20 4.05583 20H15.9442C17.18 20 18.2442 19.0775 18.4192 17.8542L20.0175 6.66667H17.4508ZM10 1.66667C12.9325 1.66667 15.36 3.845 15.7667 6.66667H4.23333C4.64 3.845 7.0675 1.66667 10 1.66667ZM6.66666 16.6667H5V10H6.66666V16.6667ZM10.8333 16.6667H9.16666V10H10.8333V16.6667ZM15 16.6667H13.3333V10H15V16.6667Z" fill="white"/>
</g>
<defs>
<clipPath id="clip0_886_118">
<rect width="20" height="20" fill="white"/>
</clipPath>
</defs>
</svg>
`;
const foodWhite = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_886_122)">
<path d="M15.5075 0.676624C15.2991 0.394337 15.0069 0.185028 14.6726 0.0785176C14.3382 -0.0279924 13.9788 -0.0262688 13.6455 0.0834429C13.3123 0.193155 13.0221 0.405257 12.8164 0.689529C12.6107 0.973801 12.5 1.31574 12.5 1.66662V20H14.1667V16.3883C18.1667 12.0116 20.3333 6.79662 15.5075 0.676624ZM10 -4.31517e-05V7.49996C10 8.163 9.73661 8.79888 9.26776 9.26772C8.79892 9.73657 8.16304 9.99996 7.5 9.99996H6.66666V20H5V9.99996H4.16666C3.50362 9.99996 2.86774 9.73657 2.3989 9.26772C1.93006 8.79888 1.66666 8.163 1.66666 7.49996V-4.31517e-05H3.33333V7.49996C3.33333 7.72097 3.42113 7.93293 3.57741 8.08921C3.73369 8.24549 3.94565 8.33329 4.16666 8.33329H5V-4.31517e-05H6.66666V8.33329H7.5C7.72101 8.33329 7.93297 8.24549 8.08925 8.08921C8.24553 7.93293 8.33333 7.72097 8.33333 7.49996V-4.31517e-05H10Z" fill="white"/>
</g>
<defs>
<clipPath id="clip0_886_122">
<rect width="20" height="20" fill="white"/>
</clipPath>
</defs>
</svg>
`;
const sportWhite = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_886_126)">
<path d="M19.2675 5.93501L17.2558 3.9225L18.9225 2.25584L17.7442 1.0775L16.0775 2.74417L14.0658 0.732505C13.8337 0.500314 13.5581 0.316127 13.2547 0.190464C12.9514 0.0648005 12.6263 0.00012207 12.2979 0.00012207C11.9696 0.00012207 11.6445 0.0648005 11.3411 0.190464C11.0378 0.316127 10.7622 0.500314 10.53 0.732505L8.17333 3.08917L11.9525 6.86917L6.86917 11.9525L3.08917 8.17334L0.7325 10.53C0.263823 10.9988 0.000534058 11.6346 0.000534058 12.2975C0.000534058 12.9604 0.263823 13.5962 0.7325 14.065L2.74417 16.0775L1.0775 17.7442L2.25583 18.9225L3.9225 17.2558L5.93417 19.2675C6.16632 19.4997 6.44194 19.6839 6.74528 19.8095C7.04862 19.9352 7.37374 19.9999 7.70208 19.9999C8.03042 19.9999 8.35555 19.9352 8.65889 19.8095C8.96223 19.6839 9.23785 19.4997 9.47 19.2675L11.8267 16.9108L8.0475 13.1308L13.1308 8.0475L16.91 11.8267L19.2667 9.47001C19.7353 9.00119 19.9986 8.36542 19.9986 7.7025C19.9986 7.03959 19.7362 6.40382 19.2675 5.93501Z" fill="white"/>
</g>
<defs>
<clipPath id="clip0_886_126">
<rect width="20" height="20" fill="white"/>
</clipPath>
</defs>
</svg>
`;
const servicesWhite = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_886_130)">
<path d="M15 2.5V3.33333H20V5H15V6.66667H20V8.33333H15V10H20V11.6667H15V13.3333H20V15H15V20H13.3333V2.5C13.3333 1.83696 13.5967 1.20107 14.0656 0.732233C14.5344 0.263392 15.1703 0 15.8333 0L20 0V1.66667H15.8333C15.6123 1.66667 15.4004 1.75446 15.2441 1.91074C15.0878 2.06702 15 2.27899 15 2.5ZM11.6667 16.6667C11.6697 17.3453 11.4646 18.0086 11.079 18.5671C10.6934 19.1256 10.1459 19.5525 9.51024 19.7902C8.87458 20.028 8.18131 20.0651 7.52387 19.8967C6.86642 19.7283 6.27641 19.3624 5.83333 18.8483C5.484 19.2502 5.04326 19.5622 4.5482 19.7582C4.05314 19.9542 3.51824 20.0284 2.98853 19.9745C2.45882 19.9207 1.94978 19.7404 1.50427 19.4488C1.05876 19.1572 0.68981 18.7629 0.428465 18.299C0.16712 17.8351 0.0210296 17.3153 0.00248921 16.7831C-0.0160511 16.251 0.0935008 15.7222 0.321925 15.2413C0.55035 14.7603 0.890963 14.3413 1.3151 14.0194C1.73924 13.6975 2.23448 13.4822 2.75917 13.3917L4.92667 8.33333L3.5525 5.12583C2.85625 3.50673 2.4981 1.76246 2.5 0L4.16667 0C4.16454 1.53689 4.47647 3.058 5.08333 4.47L5.83333 6.22L6.58333 4.47C7.19019 3.058 7.50213 1.53689 7.5 0H9.16667C9.16857 1.76246 8.81042 3.50673 8.11417 5.12583L6.74 8.33333L8.90667 13.3917C9.67814 13.5264 10.3776 13.9284 10.8822 14.5272C11.3869 15.1261 11.6646 15.8835 11.6667 16.6667ZM5 16.6667C5 16.337 4.90225 16.0148 4.71912 15.7407C4.53598 15.4666 4.27568 15.253 3.97114 15.1269C3.6666 15.0007 3.33148 14.9677 3.00818 15.032C2.68488 15.0963 2.38791 15.2551 2.15482 15.4882C1.92173 15.7212 1.763 16.0182 1.69869 16.3415C1.63438 16.6648 1.66739 16.9999 1.79353 17.3045C1.91968 17.609 2.1333 17.8693 2.40738 18.0525C2.68147 18.2356 3.0037 18.3333 3.33333 18.3333C3.77536 18.3333 4.19928 18.1577 4.51184 17.8452C4.82441 17.5326 5 17.1087 5 16.6667ZM5.83333 14.485C6.19387 14.0695 6.65206 13.7502 7.16667 13.5558L5.83333 10.4483L4.5 13.5558C5.01461 13.7502 5.4728 14.0695 5.83333 14.485ZM10 16.6667C10 16.337 9.90225 16.0148 9.71912 15.7407C9.53598 15.4666 9.27568 15.253 8.97114 15.1269C8.6666 15.0007 8.33148 14.9677 8.00818 15.032C7.68488 15.0963 7.38791 15.2551 7.15482 15.4882C6.92173 15.7212 6.763 16.0182 6.69869 16.3415C6.63438 16.6648 6.66739 16.9999 6.79353 17.3045C6.91968 17.609 7.1333 17.8693 7.40738 18.0525C7.68147 18.2356 8.0037 18.3333 8.33333 18.3333C8.77536 18.3333 9.19928 18.1577 9.51184 17.8452C9.8244 17.5326 10 17.1087 10 16.6667Z" fill="white"/>
</g>
<defs>
<clipPath id="clip0_886_130">
<rect width="20" height="20" fill="white"/>
</clipPath>
</defs>
</svg>
`;
const financeWhite = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M17.5 2.5H2.5C1.83696 2.5 1.20107 2.76339 0.732233 3.23223C0.263392 3.70107 0 4.33696 0 5V6.66667H20V5C20 4.33696 19.7366 3.70107 19.2678 3.23223C18.7989 2.76339 18.163 2.5 17.5 2.5Z" fill="white"/>
<path d="M0 17.5H20V8.33333H0V17.5ZM5.83333 12.9167C5.83333 13.1639 5.76002 13.4056 5.62267 13.6111C5.48532 13.8167 5.2901 13.9769 5.06169 14.0715C4.83328 14.1661 4.58195 14.1909 4.33947 14.1426C4.09699 14.0944 3.87427 13.9754 3.69945 13.8005C3.52463 13.6257 3.40558 13.403 3.35735 13.1605C3.30912 12.9181 3.33387 12.6667 3.42848 12.4383C3.52309 12.2099 3.68331 12.0147 3.88887 11.8773C4.09443 11.74 4.33611 11.6667 4.58333 11.6667C4.91485 11.6667 5.2328 11.7984 5.46722 12.0328C5.70164 12.2672 5.83333 12.5851 5.83333 12.9167Z" fill="white"/>
</svg>
`;

const isSidebarOpen = ref(true);
const hoveredCategory = ref(null);
// Инициализируем isMobile сразу правильно для SSR/CSR
const isMobile = ref(process.client ? window.innerWidth <= 599 : false);
const isMd = ref(process.client ? window.innerWidth <= 1024 : false);
const isMapDialogOpen = ref(false);
const isMapReady = ref(false);

// Разные центры карты для десктопа и мобильных
const mapCenter = computed(() => {
  // На мобильных устройствах используем другой центр
  return isMobile.value ? [60.19, 30.53] : [60.193412, 30.52625];
});

const mapZoom = computed(() => {
  // Можно также настроить зум для мобильных
  return isMobile.value ? 15 : 15;
});

// категории: без хардкодного count
const categories = ref([
  { name: 'Культура и отдых', key: 'culture', icon: cultureBlack, active: true },
  { name: 'Медицина', key: 'medicine', icon: medicineBlack, active: true },
  { name: 'Образование', key: 'education', icon: educationBlack, active: true },
  { name: 'Финансы', key: 'finance', icon: financeBlack, active: true },
  { name: 'Торговля', key: 'torg', icon: torgBlack, active: true },
  { name: 'Еда', key: 'food', icon: foodBlack, active: true },
  { name: 'Спорт', key: 'sport', icon: sportBlack, active: true },
  { name: 'Услуги', key: 'services', icon: servicesBlack, active: true },
]);

// locations — список всех локаций (несколько с одинаковой category)
// пример: id, coords, category
const locations = ref([
  { id: 1, coords: [60.1925, 30.5285], category: 'culture', icon: cultureWhite, color: '#4C5E36' },
  { id: 2, coords: [60.1931, 30.529], category: 'culture', icon: cultureWhite, color: '#4C5E36' },
  {
    id: 3,
    coords: [60.1932, 30.5318],
    category: 'medicine',
    icon: medicineWhite,
    color: '#4C5E36',
  },
  {
    id: 4,
    coords: [60.194, 30.533],
    category: 'education',
    icon: educationWhite,
    color: '#4C5E36',
  },
  { id: 5, coords: [60.1941, 30.5342], category: 'finance', icon: financeWhite, color: '#4C5E36' },
  { id: 6, coords: [60.1939, 30.5346], category: 'food', icon: foodWhite, color: '#4C5E36' },
  { id: 7, coords: [60.1964, 30.5326], category: 'sport', icon: sportWhite, color: '#4C5E36' },
  {
    id: 8,
    coords: [60.1954, 30.5326],
    category: 'services',
    icon: servicesWhite,
    color: '#4C5E36',
  },
  { id: 9, coords: [60.1974, 30.5326], category: 'torg', icon: torgWhite, color: '#4C5E36' },
  // <- добавляй реальные локации сюда
]);

function toggleCategory(cat) {
  cat.active = !cat.active;
}

const activeCategoryKeys = computed(() => categories.value.filter(c => c.active).map(c => c.key));

const totalCountByCategory = computed(() => {
  const mapCounts = {};
  categories.value.forEach(c => (mapCounts[c.key] = 0));
  locations.value.forEach(loc => {
    mapCounts[loc.category] = (mapCounts[loc.category] || 0) + 1;
  });
  return mapCounts;
});

const categoryIcon = computed(() => {
  return (categoryKey, isHovered = false) => {
    const category = categories.value.find(cat => cat.key === categoryKey);
    if (!category) return '';

    // Если категория неактивна - возвращаем серую иконку
    if (!category.active) {
      return getGrayIcon(categoryKey);
    }

    // Если наведена - возвращаем оранжевую иконку
    if (isHovered) {
      return getOrangeIcon(categoryKey);
    }

    // По умолчанию - черная иконка
    return category.icon;
  };
});

// Функции для получения иконок разных цветов
function getOrangeIcon(categoryKey) {
  const orangeIcons = {
    culture: cultureBlack.replace(/fill="black"/g, 'fill="#ff6b35"'),
    medicine: medicineBlack.replace(/fill="black"/g, 'fill="#ff6b35"'),
    education: educationBlack.replace(/fill="black"/g, 'fill="#ff6b35"'),
    finance: financeBlack.replace(/fill="black"/g, 'fill="#ff6b35"'),
    torg: torgBlack.replace(/fill="black"/g, 'fill="#ff6b35"'),
    food: foodBlack.replace(/fill="black"/g, 'fill="#ff6b35"'),
    sport: sportBlack.replace(/fill="black"/g, 'fill="#ff6b35"'),
    services: servicesBlack.replace(/fill="black"/g, 'fill="#ff6b35"'),
  };
  return orangeIcons[categoryKey] || '';
}

function getGrayIcon(categoryKey) {
  const grayIcons = {
    culture: cultureBlack.replace(/fill="black"/g, 'fill="#D5D6D5"'),
    medicine: medicineBlack.replace(/fill="black"/g, 'fill="#D5D6D5"'),
    education: educationBlack.replace(/fill="black"/g, 'fill="#D5D6D5"'),
    finance: financeBlack.replace(/fill="black"/g, 'fill="#D5D6D5"'),
    torg: torgBlack.replace(/fill="black"/g, 'fill="#D5D6D5"'),
    food: foodBlack.replace(/fill="black"/g, 'fill="#D5D6D5"'),
    sport: sportBlack.replace(/fill="black"/g, 'fill="#D5D6D5"'),
    services: servicesBlack.replace(/fill="black"/g, 'fill="#D5D6D5"'),
  };
  return grayIcons[categoryKey] || '';
}
function handleCategoryMouseEnter(key) {
  hoveredCategory.value = key;
}
function handleCategoryMouseLeave() {
  hoveredCategory.value = null;
}

function openMapDialog() {
  isMapDialogOpen.value = true;
}

// Проверка мобильного устройства
const checkMobile = () => {
  if (process.client) {
    isMobile.value = window.innerWidth <= 599;
    isMd.value = window.innerWidth <= 1024;
  }
};

onMounted(() => {
  checkMobile();
  // Устанавливаем флаг готовности карты после определения типа устройства
  isMapReady.value = true;

  if (process.client) {
    window.addEventListener('resize', checkMobile);
  }
});

onBeforeUnmount(() => {
  if (process.client) {
    window.removeEventListener('resize', checkMobile);
  }
});
</script>
<style lang="scss" scoped>
@use '@/assets/styles/variables.scss' as *;

.map {
  position: relative;
  width: 100%;
  height: 100vh;
  overflow: hidden;
  background: $bg-color-1;
  font-family: 'Akrobat';

  @media (max-width: $breakpoint-x) {
    height: auto;
    padding: 20px;
  }

  &__sidebar {
    position: absolute;
    top: 44px;
    left: 44px;
    border-radius: 7px;
    z-index: 20;
    border: 1px solid $utility-color-1;
    background-color: $bg-color-2;
    min-width: 305px;
    color: $accent-color-green;

    @media (max-width: $breakpoint-md) {
      top: auto;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      min-width: unset;
      border: none;
      border-radius: 0;
      background: transparent;
      padding: 0 0 40px 20px;
    }

    @media (max-width: $breakpoint-x) {
      display: none;
    }
  }

  &__mobile-preview {
    position: relative;
    width: 100%;
    height: 454px;
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;

    @media (min-width: calc($breakpoint-x + 1px)) {
      display: none;
    }
  }

  &__mobile-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: background 0.3s ease;

    &:hover {
      background: rgba(0, 0, 0, 0.7);
    }
  }

  &__mobile-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pulse 2s ease-in-out infinite;

    svg {
      width: 100%;
      height: 100%;
    }
  }

  &__mobile-text {
    color: $text-color-white;
    font-size: 18px;
    font-weight: 700;
    font-family: 'Akrobat';
    text-align: center;
    max-width: 165px;
  }

  &__sidebar-content {
    padding: 24px;

    @media (max-width: $breakpoint-md) {
      padding: 0;
    }
  }

  &__sidebar-title {
    font-weight: 600;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    transition: color 0.2s ease;
    font-size: 22px;

    @media (max-width: $breakpoint-md) {
      display: none;
    }
  }

  &__m {
    display: inline-block;
    font-size: 12px;
    transition: transform 0.3s ease;
    color: #666;

    &--open {
      transform: rotate(180deg);
    }
  }

  &__categories {
    list-style: none;
    margin: 0;
    padding: 0;
    transition:
      opacity 0.3s ease,
      max-height 0.3s ease;
    overflow: hidden;
    margin-top: 20px;

    @media (max-width: $breakpoint-md) {
      margin-top: 0;
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 8px;
      padding-right: 60px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;

      // Скрываем скроллбар
      scrollbar-width: none;
      -ms-overflow-style: none;

      &::-webkit-scrollbar {
        display: none;
      }
    }
  }

  &__category {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 700;
    line-height: 140%;
    padding: 8px 0;
    width: 100%;
    cursor: pointer;
    transition: all 0.3s ease;

    @media (max-width: $breakpoint-md) {
      padding: 8px 16px;
      border-radius: 50px;
      background: $bg-color-2;
      border: none;
      color: $text-color-secondary;
      font-size: 14px;
      white-space: nowrap;
      flex-shrink: 0;
      width: auto;
      justify-content: flex-start;

      &:not(.inactive) {
        background: $accent-color-orange;
        color: $text-color-white;

        .map__category-name-link,
        .map__category-count,
        .map__icon {
          color: $text-color-white;
        }
      }
    }

    &:hover {
      @media (min-width: calc($breakpoint-md + 1px)) {
        .map__category-name-link {
          color: $accent-color-orange;
        }
      }

      @media (max-width: $breakpoint-md) {
        &.inactive {
          opacity: 0.8;
        }
      }
    }
  }

  &__category-name {
    display: flex;
    align-items: center;

    @media (max-width: $breakpoint-md) {
      gap: 8px;
      align-items: flex-start;
    }

    &-link {
      margin-left: 10px;
      transition: color 0.3s ease;

      @media (max-width: $breakpoint-md) {
        margin-left: 0;
      }
    }
  }

  &__icon {
    width: 20px;
    height: 20px;

    @media (max-width: $breakpoint-md) {
      width: 16px;
      height: 16px;

      :deep(svg path),
      :deep(svg g) {
        fill: currentColor;
      }
    }

    &--inactive {
      opacity: 0.5;
    }

    &--hovered:not(.map__icon--inactive) {
      filter: invert(44%) sepia(85%) saturate(1352%) hue-rotate(345deg) brightness(101%)
        contrast(101%);
    }
  }

  &__category-count {
    transition: color 0.3s ease;
    font-weight: 700;

    @media (max-width: $breakpoint-md) {
      display: none;
    }

    &--hovered {
      color: #ff6b35;
    }
  }
}

.map__category.inactive {
  .map__category-name-link {
    color: #c0c1c0;
  }

  .map__category-count {
    color: #c0c1c0;
  }

  @media (max-width: $breakpoint-md) {
    background: #e0e0e0 !important;
    color: $text-color-secondary;

    .map__category-name-link,
    .map__category-count {
      color: $text-color-secondary;
    }
  }
}

:deep(.animated-link) {
  color: inherit;

  .animated-link__text-inner--hover .animated-link__letter {
    color: inherit;
  }
}

@keyframes pulse {
  0%,
  100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.8;
  }
}
</style>
